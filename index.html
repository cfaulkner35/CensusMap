library(tidyverse)
library(tidycensus)
library(ggplot2)
library(Hmisc)
library(sf)
library(leaflet)
library(stringr)
library(htmlwidgets)

census_api_key("12b80ea1ddcb138b84c3a2f525661786a48a7998")
ACS<-load_variables(2020,
                    "acs5",
                    cache=FALSE)
Variables<-c(MHI = "B19013_001", 
             MHV = "B25077_001", 
             Totalpop = "B01003_001") 
SacramentoMSA<-get_acs(geography = "tract",  
                variables = Variables, 
                survey = "acs5",      
                year = 2020,   
                output = "wide", 
                state="CA", 
                county= c("Sacramento","Yolo", "Placer", "El Dorado", "Sutter", "Yuba", "Nevada"), # Defining the counties in the state that the data will come from
                geometry=T) 

Sacramento<-SacramentoMSA[,c("GEOID", "NAME", "MHIE", "MHVE", "TotalpopE", "geometry")]

names(Sacramento)[names(Sacramento) =="MHIE"]<-"MHI"
names(Sacramento)[names(Sacramento) =="MHVE"]<-"MHV"
names(Sacramento)[names(Sacramento) =="TotalpopE"]<-"Totalpop"

SalMHI<-colorQuantile(palette = "magma", domain=Sacramento$MHI, n=10)
SalMHV<-colorQuantile(palette = "RdYlGn", domain=Sacramento$MHV, n=10)
Salpop<-colorQuantile(palette = "RdBu", domain=Sacramento$Totalpop, n=10)


### The Leaflet map

Samap<-Sacramento %>% 
  st_transform(crs = "+init=epsg:4326") %>% 
  leaflet() %>%  
  setView(lng = -121.47, lat = 38.57, zoom = 8)%>%  
  addTiles(group = "OSM (default)") %>% 
  addTiles(
    urlTemplate = paste0("https://tiles.stadiamaps.com/tiles/stamen_toner_lite/{z}/{x}/{y}@2x.png?api_key=6308a316-587e-4ce8-b35d-5381a2c5c79e"),
    attribution = '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a> contributors',
    group = "Toner Lite"  
  ) %>%
  addProviderTiles(providers$CartoDB.Positron, group = "Carto B") %>%
  addPolygons(group = "Total", 
              popup = paste("Census Tract: ", Sacramento$NAME, "<br>",
                            "Total Population: ", Sacramento$Totalpop, "<br>",    
                            "Median Household Income: ", "$", Sacramento$MHI, "<br>",
                            "Median Home Value: ", "$", Sacramento$MHV, "<br>"),
              stroke = FALSE,
              smoothFactor = 0,
              fillOpacity = 0.7,
              color = ~ Salpop(Totalpop)) %>% 
  addLegend(position = "bottomleft", pal=Salpop, values= Sacramento$Totalpop, #Legend for this polygon layer
            title="Percentile of Census Tract Total Population", group = "Total", opacity = 1) %>% 
  addPolygons(group = "MHI", #Next layer with the same set up as before.  We could add as many as the computer would let us. 
              popup = paste("Census Tract: ", Sacramento$NAME, "<br>",
                            "Total Population: ", Sacramento$Totalpop, "<br>",
                            "Median Household Income: ", "$", Sacramento$MHI, "<br>",
                            "Median Home Value: ", "$", Sacramento$MHV, "<br>"),
              stroke = FALSE,
              smoothFactor = 0,
              fillOpacity = 0.7,
              color = ~ SalMHI(MHI)) %>%
  addLegend(position = "bottomright", pal=SalMHI, values= Sacramento$MHI, 
            title="Percentile of Census Tract Median Household Income", group = "MHI", opacity = 1) %>% 
  addPolygons(group = "MHV",
              popup = paste("Census Tract: ", Sacramento$NAME, "<br>",
                            "Total Population: ", Sacramento$Totalpop, "<br>",
                            "Median Household Income: ", "$", Sacramento$MHI, "<br>",
                            "Median Home Value: ", "$", Sacramento$MHV, "<br>"),
              stroke = FALSE,
              smoothFactor = 0,
              fillOpacity = 0.7,
              color = ~ SalMHV(MHV)) %>%
  addLegend(position = "bottomleft", pal=SalMHV, values= Sacramento$MHV, 
            title="Percentile of Census Tract Median Household Income", group = "MHV", opacity = 1) %>% 
  
  hideGroup("MHI") %>% 
  hideGroup("MHV") %>% 
  addLayersControl(
    baseGroups = c("OSM (default)", "Toner Lite", "Carto B"),
    overlayGroups = c("Total", "MHI", "MHV"),
    options = layersControlOptions(collapsed = FALSE)) 


Samap

saveWidget(Samap, file="Samap.html", selfcontained = T)
